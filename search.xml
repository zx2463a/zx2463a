<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title></title>
      <link href="/2019/05/11/STP%EF%BC%88%E7%94%9F%E6%88%90%E6%A0%91%E5%8D%8F%E8%AE%AE%EF%BC%89/"/>
      <url>/2019/05/11/STP%EF%BC%88%E7%94%9F%E6%88%90%E6%A0%91%E5%8D%8F%E8%AE%AE%EF%BC%89/</url>
      
        <content type="html"><![CDATA[<h1 id="STP（生成树协议）"><a href="#STP（生成树协议）" class="headerlink" title="STP（生成树协议）"></a>STP（生成树协议）</h1><h2 id="STP出现的背景："><a href="#STP出现的背景：" class="headerlink" title="STP出现的背景："></a>STP出现的背景：</h2><p>如果同学们仔细观察一棵树，会发现一颗树有 ，树根、树干、树杈、树枝、树叶，水分通过根，源源不断的送到主干，树杈然后到达叶子，这是因为树的物理结构是发散的，没有树干、树杈、树枝的物理交织，如果咋们的网络结构像一颗树一样自然不会发生环路，所有我们的STP就像树一样在二层网络，用一种逻辑的方法将物理的环路斩断。</p><p><img src="https://images2017.cnblogs.com/blog/352511/201801/352511-20180119104836474-1025492432.png" alt="img"></p><p><strong>为什么二层交换会产生物理环路：</strong></p><p>交换机之间为了冗余，带宽提升，或者错误的连接难免的产生一个封闭的物理环路，而以太网的转发机制又决定了不能有物理环路，一有环路，那些发给所有主机的Broadcast就会肆无忌惮的在环路上永不停的绕圈,山无棱，天地合，乃敢与环路绝！这些Frame永远无法到达目的地。</p><p><img src="https://img-blog.csdnimg.cn/20190511215317213.png" alt="在这里插入图片描述"></p><p>version 0 为STP  2为RSTP</p><h2 id="STP的基本概念："><a href="#STP的基本概念：" class="headerlink" title="STP的基本概念："></a>STP的基本概念：</h2><ul><li><p><strong>BPDU（桥协议数据单元）</strong></p><p>包含了自己桥ID，路径开销，和端口ID等。</p><p>01：80：C2:00:00:00 bpdu发送的组播MAC地址</p></li><li><p><strong>一个根桥</strong></p><p>树形的网络结构必须有树根，于是STP引入了根桥（Root Bridge）概念。</p><p>对于一个STP的网络，根桥在全网中只有一个，它是整个网络的逻辑中心，但不一定是物理中心</p></li><li><p><strong>两种度量</strong></p><p>（1）ID    又分为：BID（Bridge ID），和PID（Port ID）</p><ol><li>BID：桥ID</li></ol><p>​        IEEE 802.1D标准中规定 BID由16位的桥优先级（32768）+桥MAC地址构成。BID桥优先级占据高16位，其余48位是MAC地址。</p><ol><li><p>PID：端口ID</p><p>PID由两部分构成，高4位的优先级（128），低12位的端口号。</p><p>📖：高位是从左右往右，低位相反</p></li></ol><p>（2）路径开销</p><p>​           在一个STP网络中，某端口到根桥累计的路径开销</p></li><li><p><strong>三要素选举</strong></p></li></ul><p>总体来说有三个要素：根桥、根端口（RP）、指定端口（DP）。</p><p><img src="https://img-blog.csdnimg.cn/20190511215335905.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI2NjQyNA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><ol><li><p>根桥RB（Root Bridge）</p><p>根桥就是网桥ID最小的桥，通过交互配置BPDU协议报文选举出最小的BID</p></li><li><p>根端口 RP（Root port）</p><p>去往根桥路径开销最小的端口，负责向根桥方向转发数据，根桥上没有根端口。</p></li><li><p>指定端口 DP（Designated Port）</p><p>根桥上所有的端口都是指定端口。</p><ol><li>比较到根桥的COST值，小的成为DP</li><li>比较桥ID，小的成为DP</li><li>比较端口ID，小的成为DP</li><li>剩下的端口为AP为阻塞端口</li></ol></li></ol><ul><li><p>四个比较原则</p><p>配置BPDU中携带的主要信息：</p><p>| 字段内容：                                 | 简要说明：                    |<br>| —————————————— | —————————– |<br>| 根桥ID                                     | 每个STP网络有且仅有一个根     |<br>| 累计根路径开销                             | 转发配置BPDU 端口到根桥的距离 |<br>| BID                                        | BPDU发送桥的ID                |<br>| PID                                        | 网桥发送BPDU的端口            |<br>| 📖说明：在STP计算过程中，都遵循数值越小越好 |                               |</p><p>1.最小BID：用来选举根桥</p><p>2.最小路径开销：用来在非根桥上选举根端口</p><p>3.最小发送这BID：如果开销一样，桥ID小的获胜32768+MAC</p><p>4.最小PID：比较128+端口号，值小的成为DP，值大的成为AP</p></li><li><p><strong>五种端口状态</strong></p><p>| 端口状态  | 目的                              | 说明                         |<br>| ——— | ——————————— | —————————- |<br>| Disabled  | 端口不处理BPDU，不转发数据流量    | 端口状态为DOWN               |<br>| Listening | 确定端口角色，选举出根桥，RP，DP  | 过度状态                     |<br>| Learning  | 接收流量，学习MAC地址表，但不转发 | 增加Learning状态防止临时环路 |<br>| Fowarding | 即转发用户流量也处理BPDU          | 只有RP和DP才能进入Forwarding |<br>| Biocking  | 端口接收BPDU，不转发用户流量      | 阻塞端口最终状态             |<br>|           |                                   |                              |</p></li></ul><p><img src="https://img-blog.csdnimg.cn/20190511215404386.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3dlaXhpbl80NDI2NjQyNA==,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p><h2 id="影响端口状态和端口收敛参数"><a href="#影响端口状态和端口收敛参数" class="headerlink" title="影响端口状态和端口收敛参数"></a>影响端口状态和端口收敛参数</h2><ul><li><p>Hello Time （2秒）</p><p>运行STP协议设备发送配置BPDU的时间间隔，用于检测链路是否故障。</p></li><li><p>Forward Delay（15秒）</p><p>设备状态迁移时间。当拓扑发生变化后，重新生成树计算，重新计算得到的时间无法立刻传遍整个网络，如果立即转发数据会造成临时环路，为此STP采用了状态迁移机制，新选出来的RP和DP要经过2倍Forward Delay 延时后才能进入转发状态。</p><p>📃说明：</p><p><strong>Listening进入到Learning需要15秒时间，Learning进入Fowarding时间需要15秒</strong></p></li><li><p>Max Age（20秒）</p><p>端口BPDU报文老化时间，可在根桥上修改。</p></li></ul><h2 id="STP报文格式"><a href="#STP报文格式" class="headerlink" title="STP报文格式"></a>STP报文格式</h2><p>前面介绍了 桥ID，路径开销，和端口ID等信息，这些都是通过BPDU协议报文传输</p><ul><li><p>配置BPDU是一种心跳报文，只要端口能使能STP，则配置BPDU就会按照Hello Time定时器发送</p><p>配置BPDU在以下三种情况产生：</p><ol><li>端口使能STP。</li><li>当RP接收到配置BPDU，跟端口会在设备向每个DP复制一份BPDU发出</li><li>当DP收到比自己差的BPDU时，会立刻向下游设备发送自己的BPDU</li></ol></li><li><p>TCN BPDU是在设备检测网络拓扑发生变化时发出</p><p><img src="https://download.huawei.com/mdl/imgDownload?uuid=0f7c0325317c4f4db0fcc922271c6588.png" alt="img"></p></li></ul><h2 id="拓扑变更："><a href="#拓扑变更：" class="headerlink" title="拓扑变更："></a>拓扑变更：</h2><p><strong>当链路拓扑发生变化时</strong>，会从自己设备RP向上游发送TCN BPDU，上游非根桥交换回复 TCA置为确认BPDU ，同时向上继续传递TCN BPDU，根桥收到TCN BPDU后，向下游发送TC置为的配置BPDU，所有得到TC置为的BPDU后，会将自己MAC地址表300秒老化成15秒，重新学习MAC地址表</p><p><strong>阻塞端口的开启</strong>，如果本地交换直连链路DOWN掉，交换机立刻开启阻塞端口将状态变为15s的listening，15s的learning，最后forwarding，如果是非直连链路down掉，阻塞接口需要等待20s的BPDI超时时间，所以阻塞端口再开启需要30-50s。</p><h2 id="STP的不足之处"><a href="#STP的不足之处" class="headerlink" title="STP的不足之处"></a>STP的不足之处</h2><p>STP虽然能够解决环路，但是由于网络拓扑收敛慢，影响了客户质量，如果有新接入的主机会发送TCN BPDU导致所有的设备重新进行生成树计算</p>]]></content>
      
      
      
    </entry>
    
    
  
  
</search>
